<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thought Evaluator (Firebase Edition)</title>
  
  <!-- Firebase SDKs (Authentication removed) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Main Page Styles */
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f4f4f9;
      color: #333;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    #app-loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); z-index: 10;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5em; color: #5A67D8;
    }
    #sync-status {
        position: fixed; top: 10px; right: 10px; background-color: #5A67D8; color: white;
        padding: 5px 10px; border-radius: 12px; font-size: 0.9em; z-index: 5;
    }
    .container {
      width: 90%;
      max-width: 800px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin: auto;
      margin-bottom: 20px;
    }
    h1, h2, h3 {
      color: #5A67D8;
    }
    textarea, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    /* Buttons */
    button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      background: #28a745;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background: #218838;
    }
    .btn-secondary {
      background: #E53E3E;
    }
     .btn-secondary:hover {
      background: #c53030;
    }
    .btn-edit {
      background-color: #f0ad4e;
      color: white;
      width: 28px; height: 28px;
      line-height: 28px; font-weight: bold;
      border-radius: 50%; border: none;
      cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .btn-edit:hover { background-color: #ec971f; }

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    .checkbox-container, .category-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .category-container label {
      font-size: 16px;
    }
    /* Chart Container */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
      margin-top: 20px;
    }
    /* Calendar Styles */
    #calendar {
      margin-top: 20px;
    }
    #calendar table {
      width: 100%;
      border-collapse: collapse;
    }
    #calendar th, #calendar td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    #calendar th {
      background-color: #5A67D8;
      color: white;
    }
    #calendar td:hover {
      background-color: #f0f0f0;
      cursor: pointer;
    }
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 500px;
      border-radius: 10px;
      text-align: left;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal-content ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .modal-content li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      margin-bottom: 5px;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-content li:last-child {
      border-bottom: none;
    }
    .thought-content {
        flex-grow: 1;
        margin-right: 10px;
    }
    .thought-controls {
        display: flex;
        gap: 8px;
    }
    .timestamp {
      color: #666;
      font-size: 0.9em;
    }
    .thought-text {
      font-size: 1em;
      margin-top: 5px;
    }
    .prejudiced-tag {
      color: red;
      font-weight: bold;
      margin-left: 5px;
    }
    /* Extra Boxes Styles */
    .extra-boxes {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 30px;
      justify-content: center;
    }
    .box {
      flex: 1;
      min-width: 280px;
      max-width: 380px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      max-height: 400px;
    }
    .box-title {
      margin: 0;
      padding: 10px;
      text-align: center;
      background-color: darkred;
      color: white;
      border-radius: 6px;
    }
    .box-content {
      padding: 10px;
      flex-grow: 1;
      overflow-y: auto;
      border-top: 1px solid #ddd;
      margin-top: 10px;
    }
    .box-content ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .box-content li {
      background: #e8f0ff;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .item-controls {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      display: flex;
      gap: 5px;
    }
    .delete-btn {
      background-color: red; color: white; border: none;
      border-radius: 50%; width: 28px; height: 28px;
      font-weight: bold; line-height: 28px; cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    /* Badge styles for Labels */
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 12px;
      color: #f8f9fa;
      font-size: 0.85em;
      font-weight: bold;
    }
    .badge-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .box-reset-btn {
      background: #E53E3E;
      width: auto;
      padding: 5px 10px;
      font-size: 14px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="app-loader">Connecting to Database...</div>
  <div id="sync-status">Connecting...</div>

  <!-- Main Thought Evaluator -->
  <div class="container">
    <h1>Thought Evaluator</h1>
    <input type="hidden" id="editingThoughtId" />
    <textarea id="thoughtInput" placeholder="Write your thought..."></textarea>
    <input type="text" id="thoughtLabels" placeholder="Additional labels (comma-separated)" />
    <div class="category-container" id="categories">
      <label><input type="checkbox" value="बुद्धि" /> बुद्धि</label>
      <label><input type="checkbox" value="विवेक" /> विवेक</label>
      <label><input type="checkbox" value="संस्कार" /> संस्कार</label>
      <label><input type="checkbox" value="चित्त" /> चित्त</label>
      <label><input type="checkbox" value="शरीर" /> शरीर</label>
    </div>
    <div class="checkbox-container">
      <label><input type="checkbox" id="prejudiced" /> Prejudiced</label>
    </div>
    <button id="saveThoughtBtn" onclick="saveThought()">Save Thought</button>
    <button class="btn-secondary" onclick="resetAllData()">Reset All Data</button>
    
    <h2>Thought Analysis</h2>
    <div class="chart-container">
      <canvas id="thoughtClock"></canvas>
    </div>
    
    <h3>Monthly Calendar</h3>
    <div class="nav-buttons">
      <button onclick="prevMonth()">&lt; Previous Month</button>
      <span id="calendarMonthYear"></span>
      <button onclick="nextMonth()">Next Month &gt;</button>
    </div>
    <div id="calendar"></div>
  </div>

  <!-- Modal for Daily Thoughts -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h3 id="modalHeader"></h3>
      <div id="modalData"></div>
    </div>
  </div>

  <!-- Extra Boxes Section -->
  <div class="extra-boxes">
    <!-- Box 1: Past Memories & Experiences -->
    <div class="box" id="box1">
      <h3 class="box-title">Buddhy > Past Memories & Experiences</h3>
      <div class="box-content">
        <div id="birthYearContainer">
          <label>Your Birth Year: <input type="number" id="birthYearInput" placeholder="e.g. 1990" /></label>
          <button onclick="saveBirthYear()">Save Birth Year</button>
        </div>
        <div id="memoryInputSection">
          <input type="hidden" id="editingMemoryId" />
          <textarea id="memoryText" placeholder="Enter your memory..."></textarea>
          <input type="number" id="memoryYear" placeholder="Year of memory (e.g. 2004)" />
          <button id="saveMemoryBtn" onclick="saveMemory()">Save Memory</button>
        </div>
        <button class="box-reset-btn" onclick="resetBox('memories')">Reset Box</button>
        <div id="memoryList" class="list-container"></div>
      </div>
    </div>
    <!-- Box 2: Ego (aham) -->
    <div class="box" id="box2">
      <h3 class="box-title">Sanskar > Ego (aham)</h3>
      <div class="box-content">
        <input type="hidden" id="editingEgoId" />
        <textarea id="egoText" placeholder="Enter your ego description..."></textarea>
        <input type="text" id="egoLabels" placeholder="Additional labels (comma-separated)" />
        <button id="saveEgoBtn" onclick="saveEgo()">Save Ego</button>
        <button class="box-reset-btn" onclick="resetBox('ego')">Reset Box</button>
        <div id="egoList" class="list-container"></div>
      </div>
    </div>
    <!-- Box 3: Habits -->
    <div class="box" id="box3">
      <h3 class="box-title">Sanskar > Habits</h3>
      <div class="box-content">
        <input type="hidden" id="editingHabitsId" />
        <textarea id="habitsText" placeholder="Enter your habit..."></textarea>
        <input type="text" id="habitsLabels" placeholder="Additional labels (comma-separated)" />
        <button id="saveHabitsBtn" onclick="saveHabit()">Save Habit</button>
        <button class="box-reset-btn" onclick="resetBox('habits')">Reset Box</button>
        <div id="habitsList" class="list-container"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyDyqLW6K7aMZudaGHRvxrceQDaANQE4c4Q",
        authDomain: "local-to-firebass.firebaseapp.com",
        databaseURL: "https://local-to-firebass-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "local-to-firebass",
        storageBucket: "local-to-firebass.appspot.com",
        messagingSenderId: "121890064671",
        appId: "1:121890064671:web:9143764a66282571c1c82a"
    };

    // --- Global State ---
    let firebaseDb, userId;
    let AppData = { thoughts: {}, memories: {}, ego: {}, habits: {}, birthYear: '' };
    const AppState = { currentDateForModal: null };

    // --- Firebase Initialization and User ID Management ---
    function initializeFirebase() {
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseDb = firebase.database();
            userId = getOrCreateLocalUserId();
            loadDataFromFirebase();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('app-loader').innerText = 'Connection Failed. Check console.';
            setSyncStatus('Error');
        }
    }

    function getOrCreateLocalUserId() {
        let localUserId = localStorage.getItem('firebaseUserId');
        if (!localUserId) {
            localUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('firebaseUserId', localUserId);
        }
        return localUserId;
    }
    
    function setSyncStatus(status) {
        const statusEl = document.getElementById('sync-status');
        statusEl.textContent = status;
        if (status === 'Error') {
            statusEl.style.backgroundColor = '#E53E3E';
        } else if (status === 'Synced') {
            statusEl.style.backgroundColor = '#28a745';
        } else {
            statusEl.style.backgroundColor = '#f0ad4e'; // Saving or Deleting
        }
    }

    function loadDataFromFirebase() {
        const userRef = firebaseDb.ref('users/' + userId);
        document.getElementById('app-loader').innerText = 'Loading & Syncing Data...';
        userRef.on('value', snapshot => {
            const data = snapshot.val() || {};
            AppData = {
                thoughts: data.thoughts || {},
                memories: data.memories || {},
                ego: data.ego || {},
                habits: data.habits || {},
                birthYear: data.birthYear || ''
            };
            document.getElementById('app-loader').style.display = 'none';
            setSyncStatus('Synced');
            updateAllViews();
        }, error => {
            console.error("Firebase data read failed:", error);
            setSyncStatus('Error');
            document.getElementById('app-loader').innerText = 'Failed to load data. Check console.';
        });
    }

    /* ---------- Utility Functions ---------- */
    function getLabelColors(labels) {
      const palette = ["#2c3e50", "#8e44ad", "#16a085", "#27ae60", "#2980b9", "#d35400", "#c03E53E3E92b", "#e67e22", "#1abc9c"];
      return (labels || []).map((_, i) => palette[i % palette.length]);
    }
    function getISTTimestamp() {
      const now = new Date();
      const dateIST = now.toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' });
      const timeIST = now.toLocaleTimeString('en-GB', { timeZone: 'Asia/Kolkata', hour12: false });
      return { date: dateIST, time: timeIST, full: `${dateIST} ${timeIST}` };
    }

    /* ---------- Main Thought Evaluator ---------- */
    function saveThought() {
      const thought = document.getElementById("thoughtInput").value;
      const prejudiced = document.getElementById("prejudiced").checked;
      let categories = Array.from(document.querySelectorAll("#categories input:checked")).map(cb => ({ type: cb.value }));
      
      if (!thought.trim() || !categories.length) {
        alert("Please enter a thought and select at least one category.");
        return;
      }

      const userLabels = document.getElementById("thoughtLabels").value.split(',').map(l => l.trim()).filter(Boolean);
      const categoryLabels = categories.map(cat => cat.type);
      const combinedLabels = new Set([...userLabels, ...categoryLabels]);
      if (prejudiced) combinedLabels.add("Prejudiced");
      const finalLabels = Array.from(combinedLabels);

      const editingId = document.getElementById("editingThoughtId").value;
      const thoughtId = editingId || Date.now();

      const thoughtData = {
          id: thoughtId,
          thought,
          categories,
          labels: finalLabels,
          prejudiced,
          timestamp: editingId ? (AppData.thoughts[editingId]?.timestamp || getISTTimestamp().full) : getISTTimestamp().full
      };
      
      setSyncStatus('Saving...');
      firebaseDb.ref(`users/${userId}/thoughts/${thoughtId}`).set(thoughtData)
        .then(() => {
            resetThoughtForm();
        })
        .catch(error => {
            console.error("Error saving thought: ", error);
            setSyncStatus('Error');
        });
    }
    
    function deleteThought(id) {
        if(confirm("Are you sure you want to delete this thought?")) {
            setSyncStatus('Deleting...');
            firebaseDb.ref(`users/${userId}/thoughts/${id}`).remove()
                .then(() => {
                    if (AppState.currentDateForModal) {
                        openModal(AppState.currentDateForModal);
                    }
                })
                .catch(error => {
                    console.error("Error deleting thought: ", error);
                    setSyncStatus('Error');
                });
        }
    }
    
    function resetAllData() {
      if (confirm("This will permanently delete all your data from the cloud. Are you sure?")) {
        setSyncStatus('Deleting All...');
        firebaseDb.ref('users/' + userId).remove()
            .then(() => {
                resetAllForms();
            })
            .catch(error => {
                console.error("Error resetting data: ", error);
                setSyncStatus('Error');
            });
      }
    }

    /* ---------- UI Update Functions (Calendar, Chart, Modal) ---------- */
    let chart;
    function updateChart(dateFilter = null) {
      const targetDate = dateFilter || getISTTimestamp().date;
      const thoughts = Object.values(AppData.thoughts || {});
      let data = { "बुद्धि": 0, "विवेक": 0, "संस्कार": 0, "चित्त": 0, "शरीर": 0 };
      
      thoughts.forEach(t => {
        if (t.timestamp && t.timestamp.split(' ')[0] === targetDate) {
          (t.categories || []).forEach(cat => { if (cat.type in data) data[cat.type]++; });
        }
      });

      const ctx = document.getElementById("thoughtClock").getContext("2d");
      if (chart) chart.destroy();
      let values = Object.values(data);
      if (values.every(val => val === 0)) values = [1, 1, 1, 1, 1];
      chart = new Chart(ctx, {
        type: "polarArea",
        data: {
          labels: Object.keys(data),
          datasets: [{ data: values, backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#8e44ad"] }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    let currentCalendarYear, currentCalendarMonth;
    (function initCalendarState() {
      const now = new Date();
      currentCalendarYear = now.getFullYear();
      currentCalendarMonth = now.getMonth();
    })();

    function generateCalendar() {
      const calendarDiv = document.getElementById("calendar");
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      document.getElementById("calendarMonthYear").innerText = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
      const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
      const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
      
      let table = '<table><thead><tr>' + ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map(d => `<th>${d}</th>`).join('') + '</tr></thead><tbody><tr>';
      for (let i = 0; i < firstDay; i++) table += "<td></td>";
      
      const thoughtsByDate = {};
      Object.values(AppData.thoughts || {}).forEach(t => {
          if(t.timestamp) {
              const date = t.timestamp.split(' ')[0];
              thoughtsByDate[date] = true;
          }
      });

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = new Date(currentCalendarYear, currentCalendarMonth, day).toLocaleDateString('en-CA');
        const hasThoughts = thoughtsByDate[dateStr];
        table += `<td style="${hasThoughts ? 'background-color:#e2e8f0; font-weight:bold; cursor:pointer;' : 'cursor:pointer;'}" onclick="calendarCellClicked('${dateStr}')">${day}</td>`;
        if ((day + firstDay) % 7 === 0) table += "</tr><tr>";
      }
      table += "</tr></tbody></table>";
      calendarDiv.innerHTML = table;
    }
    
    function openModal(dateStr) {
      AppState.currentDateForModal = dateStr;
      const filtered = Object.values(AppData.thoughts || {}).filter(t => t.timestamp && t.timestamp.split(' ')[0] === dateStr);
      
      document.getElementById("modalHeader").innerText = `Thoughts for ${dateStr}`;
      const modalData = document.getElementById("modalData");
      if (filtered.length === 0) {
        modalData.innerHTML = "<p>No thoughts recorded for this day.</p>";
      } else {
        let content = "<ul>";
        filtered.sort((a,b) => b.id - a.id);
        filtered.forEach(t => {
            const time = t.timestamp.split(' ')[1];
            const prejudiceTag = t.prejudiced ? '<span class="prejudiced-tag">pre-judged</span>' : '';
            const colors = getLabelColors(t.labels);
            const labelsHtml = (t.labels || []).map((label, idx) => `<span class="badge" style="background-color:${colors[idx]};">#${label}</span>`).join(" ");

            content += `<li>
                <div class="thought-content">
                    <div class="timestamp">${time}</div>
                    <div class="thought-text">${t.thought} ${prejudiceTag}</div>
                    <div class="badge-container">${labelsHtml}</div>
                </div>
                <div class="thought-controls">
                    <button class="btn-edit" onclick="editThought('${t.id}')">&#9998;</button>
                    <button class="delete-btn" onclick="deleteThought('${t.id}')">&times;</button>
                </div>
            </li>`;
        });
        content += "</ul>";
        modalData.innerHTML = content;
      }
      document.getElementById("modal").style.display = "block";
    }

    /* ---------- Extra Boxes CRUD ---------- */
    function saveData(type, data, callback) {
        const editingId = data.id;
        const itemId = editingId || Date.now();
        data.id = itemId;
        
        setSyncStatus('Saving...');
        firebaseDb.ref(`users/${userId}/${type}/${itemId}`).set(data)
            .then(() => {
                if (callback) callback();
            })
            .catch(error => {
                console.error(`Error saving ${type}:`, error);
                setSyncStatus('Error');
            });
    }

    function saveBirthYear() {
        const birthYear = document.getElementById("birthYearInput").value;
        if (birthYear && birthYear > 1900 && birthYear < new Date().getFullYear()) {
            setSyncStatus('Saving...');
            firebaseDb.ref(`users/${userId}/birthYear`).set(birthYear)
                .catch(err => { console.error(err); setSyncStatus('Error'); });
        } else {
            alert("Please enter a valid birth year.");
        }
    }
    function saveMemory() {
      const memoryText = document.getElementById("memoryText").value;
      const memoryYear = parseInt(document.getElementById("memoryYear").value);
      if (!AppData.birthYear) { alert("Please save your birth year first."); return; }
      if (!memoryText.trim() || !memoryYear || memoryYear <= AppData.birthYear || memoryYear > new Date().getFullYear()) {
        alert("Please enter valid memory text and a year after your birth year.");
        return;
      }
      saveData('memories', {
          id: document.getElementById("editingMemoryId").value,
          memoryText,
          memoryYear,
          ageAtMemory: memoryYear - AppData.birthYear
      }, resetMemoryForm);
    }
    
    const saveEgo = () => {
        saveData('ego', {
            id: document.getElementById('editingEgoId').value,
            egoText: document.getElementById('egoText').value,
            egoLabels: document.getElementById('egoLabels').value.split(',').map(l => l.trim()).filter(Boolean)
        }, () => resetForm('ego'));
    };
    const saveHabit = () => {
        saveData('habits', {
            id: document.getElementById('editingHabitsId').value,
            habitsText: document.getElementById('habitsText').value,
            habitsLabels: document.getElementById('habitsLabels').value.split(',').map(l => l.trim()).filter(Boolean)
        }, () => resetForm('habits'));
    };

    function deleteItem(type, id) {
        setSyncStatus('Deleting...');
        firebaseDb.ref(`users/${userId}/${type}/${id}`).remove()
            .catch(error => { console.error(`Error deleting ${type}:`, error); setSyncStatus('Error'); });
    }

    function resetBox(boxKey) {
        if (confirm(`Reset all items in this box (${boxKey})?`)) {
            setSyncStatus('Deleting...');
            firebaseDb.ref(`users/${userId}/${boxKey}`).remove()
                .catch(error => { console.error(`Error resetting box:`, error); setSyncStatus('Error'); });
        }
    }

    /* ---------- UI Updates for Extra Boxes ---------- */
    function updateMemoryList() {
        if (AppData.birthYear) { 
          document.getElementById("birthYearContainer").style.display = 'none';
        } else {
          document.getElementById("birthYearContainer").style.display = 'block';
        }
        const memories = Object.values(AppData.memories || {}).sort((a, b) => a.memoryYear - b.memoryYear);
        let html = "<ul>";
        memories.forEach(m => {
            html += `<li>
                <div><strong>${m.memoryYear}</strong> (Age: ${m.ageAtMemory}): ${m.memoryText}</div>
                <div class="item-controls">
                    <button class="btn-edit" onclick="editMemory('${m.id}')">&#9998;</button>
                    <button class="delete-btn" onclick="deleteItem('memories', '${m.id}')">&times;</button>
                </div>
            </li>`;
        });
        document.getElementById("memoryList").innerHTML = html + "</ul>";
    }

    function updateList(type) {
        const items = Object.values(AppData[type] || {});
        let html = "<ul>";
        items.forEach(item => {
            const text = item[`${type}Text`] || item.egoText || item.habitsText;
            const labels = item[`${type}Labels`] || item.egoLabels || item.habitsLabels;
            const colors = getLabelColors(labels);
            const labelsHtml = (labels || []).map((l, idx) => `<span class="badge" style="background-color:${colors[idx]};">#${l}</span>`).join(' ');
            html += `<li>
                <div>${text} <br/><div class="badge-container">${labelsHtml}</div></div>
                <div class="item-controls">
                    <button class="btn-edit" onclick="editItem('${type}', '${item.id}')">&#9998;</button>
                    <button class="delete-btn" onclick="deleteItem('${type}', '${item.id}')">&times;</button>
                </div>
            </li>`;
        });
        document.getElementById(`${type}List`).innerHTML = html + "</ul>";
    }
    const updateEgoList = () => updateList('ego');
    const updateHabitList = () => updateList('habits');

    /* ---------- Form Resets and Edit Population ---------- */
    function editThought(id) {
        const t = AppData.thoughts[id];
        if (t) {
            document.getElementById("editingThoughtId").value = t.id;
            document.getElementById("thoughtInput").value = t.thought;
            document.getElementById("thoughtLabels").value = (t.labels || []).join(", ");
            document.getElementById("prejudiced").checked = t.prejudiced;
            document.querySelectorAll("#categories input").forEach(cb => cb.checked = (t.categories || []).some(c => c.type === cb.value));
            document.getElementById("saveThoughtBtn").innerText = "Update Thought";
            closeModal();
            window.scrollTo(0, 0);
        }
    }
    function editMemory(id) {
        const m = AppData.memories[id];
        if (m) {
            document.getElementById('editingMemoryId').value = m.id;
            document.getElementById('memoryText').value = m.memoryText;
            document.getElementById('memoryYear').value = m.memoryYear;
            document.getElementById('saveMemoryBtn').innerText = 'Update Memory';
        }
    }
    function editItem(type, id) {
        const item = AppData[type][id];
        if (item) {
            const capType = type.charAt(0).toUpperCase() + type.slice(1);
            document.getElementById(`editing${capType}Id`).value = item.id;
            document.getElementById(`${type}Text`).value = item[`${type}Text`] || item.egoText || item.habitsText;
            document.getElementById(`${type}Labels`).value = (item[`${type}Labels`] || item.egoLabels || item.habitsLabels || []).join(', ');
            document.getElementById(`save${capType}Btn`).innerText = `Update ${capType}`;
        }
    }
    
    function resetThoughtForm() {
        document.getElementById("editingThoughtId").value = "";
        document.getElementById("thoughtInput").value = "";
        document.getElementById("thoughtLabels").value = "";
        document.getElementById("prejudiced").checked = false;
        document.querySelectorAll("#categories input").forEach(cb => cb.checked = false);
        document.getElementById("saveThoughtBtn").innerText = "Save Thought";
    }
    function resetMemoryForm() {
        document.getElementById('editingMemoryId').value = '';
        document.getElementById('memoryText').value = '';
        document.getElementById('memoryYear').value = '';
        document.getElementById('saveMemoryBtn').innerText = 'Save Memory';
    }
    function resetForm(type) {
        const capType = type.charAt(0).toUpperCase() + type.slice(1);
        document.getElementById(`editing${capType}Id`).value = '';
        document.getElementById(`${type}Text`).value = '';
        document.getElementById(`${type}Labels`).value = '';
        document.getElementById(`save${capType}Btn`).innerText = `Save ${capType}`;
    }
    function resetAllForms() {
        resetThoughtForm();
        resetMemoryForm();
        resetForm('ego');
        resetForm('habits');
    }

    /* ---------- Global Update and Event Listeners ---------- */
    function updateAllViews() {
        updateChart();
        generateCalendar();
        updateMemoryList();
        updateEgoList();
        updateHabitList();
    }

    const modal = document.getElementById("modal");
    document.getElementById("closeModal").onclick = () => { modal.style.display = "none"; updateChart(); };
    window.onclick = (event) => { if (event.target == modal) { modal.style.display = "none"; updateChart(); } };
    const calendarCellClicked = (dateStr) => { updateChart(dateStr); openModal(dateStr); };
    const prevMonth = () => { currentCalendarMonth--; if (currentCalendarMonth < 0) { currentCalendarMonth = 11; currentCalendarYear--; } generateCalendar(); };
    const nextMonth = () => { currentCalendarMonth++; if (currentCalendarMonth > 11) { currentCalendarMonth = 0; currentCalendarYear++; } generateCalendar(); };
    
    // Start the application
    document.addEventListener("DOMContentLoaded", initializeFirebase);
  </script>
</body>
</html>

/* ---------- Debugging Functions ---------- */
    function toggleDebugView() {
        const container = document.getElementById('debug-container');
        container.style.display = container.style.display === 'block' ? 'none' : 'block';
    }

    function updateDebugView() {
        const content = {
            thoughts: JSON.parse(localStorage.getItem("thoughts") || "[]"),
            memories: JSON.parse(localStorage.getItem("memories") || "[]"),
            ego: JSON.parse(localStorage.getItem("ego") || "[]"),
            habits: JSON.parse(localStorage.getItem("habits") || "[]"),
            birthYear: localStorage.getItem("birthYear") || ""
        };
        document.getElementById('debug-content').textContent = JSON.stringify(content, null, 2);
    }

    /* ---------- Global Update and Initialization ---------- */
    function updateAllViews() {
        updateChart();
        generateCalendar();
        updateMemoryList();
        updateEgoList();
        updateHabitList();
        updateDebugView();
    }
    
    function resetAllForms() {
        resetThoughtForm();
        resetMemoryForm();
        resetForm('ego');
        resetForm('habits');
    }

    document.addEventListener("DOMContentLoaded", function() {
      updateAllViews();
    });
  </script>
</body>
</html>